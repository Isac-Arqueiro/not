<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bloco de Notas Avançado</title>

  <!-- Manifesto PWA -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://img.freepik.com/vetores-premium/icone-de-caneta-e-bloco-de-notas-vermelho-ilustracao_149267-907.jpg">
  <link rel="apple-touch-icon" href="https://img.freepik.com/vetores-premium/icone-de-caneta-e-bloco-de-notas-vermelho-ilustracao_149267-907.jpg">
  <meta name="theme-color" content="#1e90ff">

  <!-- Estilos -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">

  <style>
    body { padding-top: 70px; background: #f4f4f9; }
    #editor { height: 300px; background: #fff; }
    .note-history { max-height: 200px; overflow-y: auto; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-primary fixed-top">
    <div class="container-fluid">
      <span class="navbar-brand">📝 Bloco de Notas</span>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- Título -->
    <input type="text" id="noteTitle" class="form-control mb-2" placeholder="Título da nota">

    <!-- Editor -->
    <div id="editor"></div>

    <!-- Botões -->
    <div class="mt-3">
      <button id="saveNote" class="btn btn-success">Salvar</button>
      <button id="exportPdf" class="btn btn-danger">Exportar PDF</button>
      <button id="deleteAll" class="btn btn-warning">Apagar Todas</button>
    </div>

    <!-- Histórico -->
    <h5 class="mt-4">Histórico de Notas</h5>
    <!-- Campo de busca -->
    <input type="text" id="searchNotes" class="form-control mb-2" placeholder="🔍 Buscar no histórico...">
    <ul id="noteHistory" class="list-group note-history"></ul>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Inicializa editor
    const quill = new Quill('#editor', { theme: 'snow' });

    let db;
    const request = indexedDB.open("notesDB", 1);
    request.onupgradeneeded = e => {
      db = e.target.result;
      if (!db.objectStoreNames.contains("notes")) {
        db.createObjectStore("notes", { keyPath: "id", autoIncrement: true });
      }
    };
    request.onsuccess = e => { db = e.target.result; loadHistory(); };

    // Salvar
    document.getElementById('saveNote').addEventListener('click', () => {
      const title = document.getElementById('noteTitle').value.trim();
      const content = quill.root.innerHTML;
      if (!title) { alert("Digite um título"); return; }

      const tx = db.transaction("notes","readwrite");
      tx.objectStore("notes").add({ title, content, date: new Date() });
      tx.oncomplete = () => { loadHistory(); alert("Nota salva!"); };
    });

    // Carregar histórico
    function loadHistory() {
      const tx = db.transaction("notes","readonly");
      const req = tx.objectStore("notes").getAll();
      req.onsuccess = () => {
        const notes = req.result || [];
        const container = document.getElementById("noteHistory");
        container.innerHTML = "";

        const searchTerm = (document.getElementById("searchNotes").value || "").toLowerCase();

        notes
          .sort((a,b) => new Date(b.date) - new Date(a.date))
          .filter(n => n.title.toLowerCase().includes(searchTerm))
          .forEach(n => {
            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            li.innerHTML = `
              <div>
                <strong>${n.title}</strong><br>
                <small>${new Date(n.date).toLocaleString()}</small>
              </div>
              <div>
                <button class="btn btn-sm btn-link" onclick="loadNote(${n.id})">Carregar</button>
                <button class="btn btn-sm btn-danger" onclick="deleteNote(${n.id})">Apagar</button>
              </div>`;
            container.appendChild(li);
          });
      };
    }

    // Carregar nota
    window.loadNote = function(id) {
      const tx = db.transaction("notes","readonly");
      tx.objectStore("notes").get(id).onsuccess = e => {
        const note = e.target.result;
        if (note) {
          document.getElementById("noteTitle").value = note.title;
          quill.root.innerHTML = note.content;
        }
      };
    };

    // Apagar nota
    window.deleteNote = function(id) {
      if (!confirm("Apagar esta nota?")) return;
      const tx = db.transaction("notes","readwrite");
      tx.objectStore("notes").delete(id).onsuccess = () => { loadHistory(); };
    };

    // Apagar todas
    document.getElementById("deleteAll").addEventListener("click", () => {
      if (!confirm("Apagar TODAS as notas?")) return;
      const tx = db.transaction("notes","readwrite");
      tx.objectStore("notes").clear().onsuccess = () => { loadHistory(); };
    });

    // Exportar PDF
    document.getElementById("exportPdf").addEventListener("click", async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const editorContent = document.getElementById("editor");

      await doc.html(editorContent, {
        callback: (doc) => {
          doc.save((document.getElementById("noteTitle").value || "nota") + ".pdf");
        },
        x: 10, y: 10, width: 190
      });
    });

    // Busca em tempo real
    document.getElementById("searchNotes").addEventListener("input", loadHistory);

    // Service Worker
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js");
    }
  </script>
</body>
</html>
