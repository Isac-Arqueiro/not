<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bloco de Notas Avan√ßado</title>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://img.freepik.com/vetores-premium/icone-de-caneta-e-bloco-de-notas-vermelho-ilustracao_149267-907.jpg">
  <link rel="apple-touch-icon" href="https://img.freepik.com/vetores-premium/icone-de-caneta-e-bloco-de-notas-vermelho-ilustracao_149267-907.jpg">
  <meta name="theme-color" content="#1e90ff">

  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">

  <style>
    body { padding-top: 70px; background: #f4f4f9; }
    #editor { height: 300px; background: #fff; }
    .note-history { max-height: 200px; overflow-y: auto; }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-primary fixed-top">
    <div class="container-fluid">
      <span class="navbar-brand">üìù Bloco de Notas</span>
    </div>
  </nav>

  <div class="container mt-4">
    <input type="text" id="noteTitle" class="form-control mb-2" placeholder="T√≠tulo da nota">
    <div id="editor"></div>

    <div class="mt-3">
      <button id="saveNote" class="btn btn-success">Salvar</button>
      <button id="exportPdf" class="btn btn-danger">Exportar PDF</button>
      <button id="deleteAll" class="btn btn-warning">Apagar Todas</button>
    </div>

    <h5 class="mt-4">Hist√≥rico de Notas</h5>
    <input type="text" id="searchNotes" class="form-control mb-2" placeholder="üîç Buscar no hist√≥rico...">
    <ul id="noteHistory" class="list-group note-history"></ul>
  </div>

  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const quill = new Quill('#editor', { theme: 'snow' });

    let db;
    const request = indexedDB.open("notesDB", 1);
    request.onupgradeneeded = e => {
      db = e.target.result;
      if (!db.objectStoreNames.contains("notes")) {
        db.createObjectStore("notes", { keyPath: "id", autoIncrement: true });
      }
    };
    request.onsuccess = e => { db = e.target.result; loadHistory(); };

    document.getElementById('saveNote').addEventListener('click', () => {
      const title = document.getElementById('noteTitle').value.trim();
      const content = quill.root.innerHTML;
      if (!title) { alert("Digite um t√≠tulo"); return; }

      const tx = db.transaction("notes","readwrite");
      tx.objectStore("notes").add({ title, content, date: new Date() });
      tx.oncomplete = () => { loadHistory(); alert("Nota salva!"); };
    });

    function loadHistory() {
      const tx = db.transaction("notes","readonly");
      const req = tx.objectStore("notes").getAll();
      req.onsuccess = () => {
        const notes = req.result || [];
        const container = document.getElementById("noteHistory");
        container.innerHTML = "";
        const searchTerm = (document.getElementById("searchNotes").value || "").toLowerCase();

        notes
          .sort((a,b) => new Date(b.date) - new Date(a.date))
          .filter(n => n.title.toLowerCase().includes(searchTerm))
          .forEach(n => {
            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            li.innerHTML = `
              <div>
                <strong>${n.title}</strong><br>
                <small>${new Date(n.date).toLocaleString()}</small>
              </div>
              <div>
                <button class="btn btn-sm btn-link" onclick="loadNote(${n.id})">Carregar</button>
                <button class="btn btn-sm btn-danger" onclick="deleteNote(${n.id})">Apagar</button>
              </div>`;
            container.appendChild(li);
          });
      };
    }

    window.loadNote = function(id) {
      const tx = db.transaction("notes","readonly");
      tx.objectStore("notes").get(id).onsuccess = e => {
        const note = e.target.result;
        if (note) {
          document.getElementById("noteTitle").value = note.title;
          quill.root.innerHTML = note.content;
        }
      };
    };

    window.deleteNote = function(id) {
      if (!confirm("Apagar esta nota?")) return;
      const tx = db.transaction("notes","readwrite");
      tx.objectStore("notes").delete(id).onsuccess = () => { loadHistory(); };
    };

    document.getElementById("deleteAll").addEventListener("click", () => {
      if (!confirm("Apagar TODAS as notas?")) return;
      const tx = db.transaction("notes","readwrite");
      const store = tx.objectStore("notes");
      const req = store.getAllKeys();
      req.onsuccess = () => {
        req.result.forEach(key => store.delete(key));
      };
      tx.oncomplete = () => { loadHistory(); };
    });

    // PDF robusto: t√≠tulo + conte√∫do Quill com estilo
    document.getElementById("exportPdf").addEventListener("click", async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });

      // Criar container tempor√°rio para capturar HTML com estilo
      const temp = document.createElement("div");
      temp.style.background = "#fff";
      temp.style.padding = "10px";
      temp.style.width = "800px"; // aumenta resolu√ß√£o

      // Adicionar t√≠tulo
      const h = document.createElement("h2");
      h.textContent = document.getElementById("noteTitle").value || "";
      temp.appendChild(h);

      // Adicionar conte√∫do Quill
      const contentDiv = document.createElement("div");
      contentDiv.innerHTML = quill.root.innerHTML;
      temp.appendChild(contentDiv);

      // Remover elementos indesejados do Quill
      contentDiv.querySelectorAll(".ql-clipboard, .ql-tooltip").forEach(el => el.remove());

      // Usar html2canvas via doc.html()
      await doc.html(temp, {
        callback: function(doc) {
          doc.save((document.getElementById("noteTitle").value || "nota") + ".pdf");
        },
        x: 20,
        y: 20,
        html2canvas: { scale: 2, useCORS: true, allowTaint: true },
        windowWidth: temp.scrollWidth
      });
    });

    document.getElementById("searchNotes").addEventListener("input", loadHistory);

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js");
    }
  </script>
</body>
</html>
